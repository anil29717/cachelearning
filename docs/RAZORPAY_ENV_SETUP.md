# Razorpay Environment Variables Setup Guide

## üö® ERROR FIX: Invalid Razorpay API Credentials

You're seeing this error because the Razorpay API keys are not properly configured in your Supabase environment.

## Quick Fix Steps

### Step 1: Get Your Razorpay API Keys

1. Go to [Razorpay Dashboard](https://dashboard.razorpay.com/)
2. Sign in or create an account if you haven't already
3. Navigate to **Settings** ‚Üí **API Keys**
4. You'll see two modes:
   - **Test Mode** (for development) - Keys start with `rzp_test_`
   - **Live Mode** (for production) - Keys start with `rzp_live_`

5. For development, use **Test Mode** keys:
   - Click **Generate Test Key** if you don't have one
   - You'll get:
     - **Key ID**: `rzp_test_xxxxxxxxxx`
     - **Key Secret**: `xxxxxxxxxxxxxxxxxx` (longer string)

### Step 2: Set Environment Variables in Supabase

#### Option A: Using Supabase Dashboard (Recommended)

1. Go to your [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project: `wugzmhtnsffpwhgsxkgx`
3. Navigate to **Settings** ‚Üí **Edge Functions**
4. Scroll down to **Secrets**
5. Add/Update these secrets:

   **Secret Name:** `RAZORPAY_KEY_ID`  
   **Value:** Your Razorpay Key ID (e.g., `rzp_test_1234567890`)

   **Secret Name:** `RAZORPAY_KEY_SECRET`  
   **Value:** Your Razorpay Key Secret (the longer string)

6. Click **Save** for each secret

#### Option B: Using Supabase CLI

If you have the Supabase CLI installed:

```bash
# Set Razorpay Key ID
supabase secrets set RAZORPAY_KEY_ID=rzp_test_your_key_id_here

# Set Razorpay Key Secret
supabase secrets set RAZORPAY_KEY_SECRET=your_key_secret_here
```

### Step 3: Verify the Setup

After setting the environment variables:

1. **Wait 1-2 minutes** for the changes to propagate
2. **Refresh your application**
3. Try making a payment again

The error should be resolved if the keys are correctly set.

## Environment Variables Required

Here's what you need to set:

| Variable Name | Description | Example Format |
|---------------|-------------|----------------|
| `RAZORPAY_KEY_ID` | Your Razorpay Key ID | `rzp_test_1234567890` |
| `RAZORPAY_KEY_SECRET` | Your Razorpay Key Secret | `abcdefghijklmnopqrst` |
| `RAZORPAY_WEBHOOK_SECRET` | Webhook secret (optional for now) | Generated by Razorpay |

## Common Issues & Solutions

### Issue 1: "RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET are required"
**Solution:** The environment variables are not set. Follow Step 2 above.

### Issue 2: "Invalid Razorpay API credentials detected"
**Possible causes:**
- Keys are placeholder values (like `YOUR_KEY_ID_HERE`)
- Keys have extra spaces or line breaks
- Using wrong mode keys (test vs live)
- Keys are from a different Razorpay account

**Solution:**
1. Copy keys directly from Razorpay dashboard
2. Ensure no extra spaces before/after the keys
3. Use Test Mode keys for development
4. Verify you're using the correct Razorpay account

### Issue 3: "Authentication failed" when creating orders
**Possible causes:**
- Wrong Key ID or Secret
- Keys don't match (ID from one account, Secret from another)
- Account suspended or restricted

**Solution:**
1. Regenerate API keys in Razorpay dashboard
2. Update both KEY_ID and KEY_SECRET together
3. Check your Razorpay account status

### Issue 4: Changes not taking effect
**Solution:**
- Wait 1-2 minutes after setting secrets
- Clear browser cache
- Refresh the application
- Check Supabase edge function logs for confirmation

## Test Mode vs Live Mode

### Test Mode (Development)
- Keys start with `rzp_test_`
- No real money is charged
- Use test card numbers for payments
- Perfect for development and testing

**Test Card Numbers:**
- Success: `4111 1111 1111 1111`
- Failure: `4000 0000 0000 0002`
- CVV: Any 3 digits
- Expiry: Any future date

### Live Mode (Production)
- Keys start with `rzp_live_`
- Real money transactions
- Requires KYC completion in Razorpay
- Use only when going to production

## Verification Checklist

Use this checklist to verify your setup:

- [ ] Created Razorpay account at https://dashboard.razorpay.com/
- [ ] Generated Test Mode API keys
- [ ] Copied Key ID (starts with `rzp_test_`)
- [ ] Copied Key Secret (longer string, no `rzp_` prefix)
- [ ] Added `RAZORPAY_KEY_ID` in Supabase Edge Functions secrets
- [ ] Added `RAZORPAY_KEY_SECRET` in Supabase Edge Functions secrets
- [ ] Waited 1-2 minutes for changes to propagate
- [ ] Refreshed the application
- [ ] Tested payment creation

## Need Help?

If you're still seeing errors after following these steps:

1. **Check the browser console** for detailed error messages
2. **Check Supabase logs:**
   - Go to Supabase Dashboard
   - Navigate to **Edge Functions** ‚Üí **Logs**
   - Look for Razorpay-related errors

3. **Verify keys are correct:**
   - Log into Razorpay Dashboard
   - Go to Settings ‚Üí API Keys
   - Compare the keys with what you set in Supabase
   - Make sure they match exactly

4. **Common mistakes:**
   - Copying only part of the key
   - Adding spaces before or after the key
   - Using Key ID where Key Secret should be (and vice versa)
   - Using Live Mode keys in Test Mode settings

## Important Notes

‚ö†Ô∏è **Security:**
- Never commit API keys to version control
- Never share keys publicly
- Store keys only in Supabase secrets (environment variables)
- Keys in the code are for reference only (won't work)

‚ö†Ô∏è **Key Regeneration:**
- If you regenerate keys in Razorpay, update them immediately in Supabase
- Old keys will stop working once regenerated
- Always update both KEY_ID and KEY_SECRET together

‚ö†Ô∏è **Test Mode Limitations:**
- Test mode has lower rate limits
- Some features may work differently
- Always test in test mode before going live

## Quick Debug Commands

To check if environment variables are set (in your server logs):

```typescript
console.log('Razorpay keys check:', {
  keyIdExists: !!Deno.env.get('RAZORPAY_KEY_ID'),
  keySecretExists: !!Deno.env.get('RAZORPAY_KEY_SECRET'),
  keyIdLength: Deno.env.get('RAZORPAY_KEY_ID')?.length || 0,
  keyIdPrefix: Deno.env.get('RAZORPAY_KEY_ID')?.substring(0, 8) || 'NOT_SET'
});
```

This has been added to the server code and will appear in your Supabase Edge Function logs.

## Next Steps After Setup

Once your keys are configured:

1. Test payment creation
2. Test payment verification  
3. Configure webhook (see RAZORPAY_WEBHOOK_SETUP.md)
4. Test refund functionality (admin only)
5. Test in different payment methods (UPI, card, wallet, netbanking)

## Resources

- [Razorpay Dashboard](https://dashboard.razorpay.com/)
- [Razorpay API Documentation](https://razorpay.com/docs/api/)
- [Supabase Dashboard](https://supabase.com/dashboard)
- [Test Card Numbers](https://razorpay.com/docs/payments/payments/test-card-details/)
